<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yalla Azzouzi | يلا عزوزي - البث المباشر</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        :root { --red: #ff4444; --dark: #0a0a0a; --gray: #1a1a1a; }
        body { background: var(--dark); color: white; font-family: sans-serif; margin: 0; }
        header { background: #000; padding: 15px; text-align: center; border-bottom: 2px solid var(--red); }
        .container { max-width: 1000px; margin: auto; padding: 20px; }
        .video-box { background: #000; border-radius: 10px; overflow: hidden; border: 1px solid #333; margin-bottom: 20px; }
        video { width: 100%; aspect-ratio: 16/9; }
        .info-bar { background: var(--red); padding: 8px; font-size: 14px; text-align: center; font-weight: bold; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 12px; max-height: 500px; overflow-y: auto; padding: 10px; background: var(--gray); border-radius: 8px; }
        .card { background: #252525; padding: 10px; border-radius: 6px; text-align: center; cursor: pointer; border: 1px solid transparent; font-size: 11px; transition: 0.2s; }
        .card:hover { border-color: var(--red); transform: scale(1.02); }
        .card img { width: 40px; height: 40px; object-fit: contain; margin-bottom: 5px; display: block; margin-left: auto; margin-right: auto; }
        .badge { font-size: 9px; background: #444; padding: 2px 5px; border-radius: 3px; display: block; margin-bottom: 5px; }
    </style>
</head>
<body>

<header><h1>YALLA AZZOUZI</h1></header>

<div class="container">
    <div class="video-box">
        <div id="status" class="info-bar">اختر قناة لبدء البث المباشر</div>
        <video id="video" controls autoplay playsinline></video>
    </div>

    <div id="channel-list" class="grid">
        <p style="text-align:center; width:100%;">جاري فحص ملفات المجموعات...</p>
    </div>
</div>

<script>
    const files = ['playlist.m3u8', 'playlist (2).m3u8'];
    const video = document.getElementById('video');
    const status = document.getElementById('status');
    const list = document.getElementById('channel-list');

    async function init() {
        list.innerHTML = '';
        for (const f of files) {
            try {
                const r = await fetch(f);
                const t = await r.text();
                parse(t, f);
            } catch (e) { console.error("Error loading " + f); }
        }
    }

    function parse(data, filename) {
        const lines = data.split('\n');
        lines.forEach((line, i) => {
            if (line.startsWith('#EXTINF')) {
                const name = line.split(',')[1] || "قناة";
                const logoMatch = line.match(/tvg-logo="([^"]+)"/);
                const logo = logoMatch ? logoMatch[1] : 'https://cdn-icons-png.flaticon.com/512/716/716429.png';
                const url = lines[i+1]?.trim();
                if (url && url.startsWith('http')) {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `<span class="badge">${filename}</span><img src="${logo}"><div>${name}</div>`;
                    card.onclick = () => playChannel(url, name);
                    list.appendChild(card);
                }
            }
        });
    }

    function playChannel(url, name) {
        status.innerText = "محاولة تشغيل: " + name;
        window.scrollTo({top: 0, behavior: 'smooth'});

        // استخدام بروكسي "allorigins" مع إضافة No-Cache لضمان تحديث الرابط
        const finalUrl = "https://api.allorigins.win/raw?url=" + encodeURIComponent(url) + "&_nocache=" + Date.now();

        if (Hls.isSupported()) {
            const hls = new Hls({
                enableWorker: true,
                lowLatencyMode: true,
                backBufferLength: 90
            });
            hls.loadSource(finalUrl);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                video.play();
                status.innerText = "بث مباشر: " + name;
            });
            
            // في حال فشل البروكسي، نحاول الرابط المباشر (للقنوات التي لا تحتاج حماية)
            hls.on(Hls.Events.ERROR, (e, data) => {
                if (data.fatal) {
                    console.log("إعادة المحاولة بدون بروكسي...");
                    hls.loadSource(url); 
                }
            });
        }
    }

    init();
</script>
</body>
</html>
